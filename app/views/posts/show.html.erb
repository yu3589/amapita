<% if @show_badge_modal %>
  <%= render "badge_modal", badge_name: @badge_name %>
<% end %>

<div class="p-1 lg:p-4">
  <div class="p-1 w-full max-w-3xl mx-auto bg-base-100 rounded-4xl">
    <h1 class="text-center text-xl lg:text-2xl p-2 lg:p-4 border-b border-base-200 w-full">
      <div class="flex items-center justify-center gap-2">
        <% unless @post.publish? %>
          <%= image_tag "lock-key.svg", class: "h-6 w-6 sm:h-7 sm:w-7 mt-1" %>
        <% end %>
        <span><%= t('.title') %></span>
      </div>
    </h1>

    <div class="flex flex-col justify-center items-center sm:flex-row sm:items-start sm:gap-6 relative">
      <div class="flex flex-col items-center sm:p-4">
        <!-- 商品画像 -->
        <figure x-data="{ imageLoaded: false }"
                x-init="imageLoaded = $el.querySelector('img')?.complete || false">
          <div x-cloak x-show="!imageLoaded" class="flex animate-pulse space-x-4">
            <div class="p-4">
              <div class="size-30 sm:size-35 rounded-xl bg-base-200"></div>
            </div>
          </div>

          <div x-show="imageLoaded" x-transition>
            <div class="p-4">
              <%= @post.decorate.post_image(
                    class: "size-30 sm:size-35",
                    "@load" => "imageLoaded = true",
                    "@error"=> "imageLoaded = true"
                  ) %>
            </div>
          </div>
        </figure>

        <!-- 商品URL -->
        <% if @post.product.product_url.present? %>
          <div class="flex flex-row underline gap-1">
            <%= image_tag "shopping-cart.svg", class: "h-6 w-6" %>
            <%= link_to t('defaults.link.product_url'),
                @post.product.product_url,
                target: "_blank",
                rel: "noopener noreferrer",
                class: "text-sm text-secondary" %>
          </div>
        <% end %>
      </div>

      <div class="flex flex-col justify-start items-center sm:items-start gap-2 px-10 lg:px-0 pt-4 lg:pt-10">
        <div class="text-sm text-base-300">
          <%= @post.product.manufacturer %>
        </div>
        <div class="text-lg sm:text-xl font-semibold">
          <%= @post.product.name %>
        </div>
        
        <div class="flex flex-col text-base flex-wrap pt-4">
          <%= user_profile_link_or_tooltip(@post.user,
              class: "flex items-center md:gap-2 md:hover:bg-stone-200/80 md:duration-250 md:rounded-4xl md:px-2 md:w-fit") do %>
            <%= @post.user.decorate.avatar_image(class: "w-10 h-10") %>
            <div class="flex flex-col p-1 gap-2">
              <span class="text-base"><%= @post.user.name %></span>

              <div class="flex flex-row flex-wrap gap-1">
                <span class="flex flex-row gap-1 text-xs rounded-full px-2 py-1 bg-success w-fit">
                  <%= image_tag "badge.svg", class: "h-5 w-5" %>
                  <%= display_post_badge(@post.user) %>
                </span>

                <% if user_signed_in? && @post.user != current_user && sweetness_twin?(@post.user) %>
                  <span class="flex flex-row gap-1 text-xs rounded-full items-center px-2 py-1 bg-info w-fit">
                    <%= image_tag "handshake.svg", class: "h-5 w-5" %>
                    <%= display_sweetness_twin_badge(@post.user) %>
                  </span>
                <% end %>
              </div>
            </div>
          <% end %>

          <!-- 編集・削除ボタン -->
          <% if user_signed_in? && current_user.own?(@post) %>
            <div class="dropdown dropdown-bottom dropdown-end absolute top-1 sm:top-2 right-4 sm:right-10 z-10">
              <div tabindex="0" role="button" class="btn btn-lg btn-square btn-ghost hover:bg-[var(--color-base-400)]">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none"
                    viewBox="0 0 24 24" class="inline-block h-7 w-7 text-base-300 stroke-current">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M5 12h.01M12 12h.01M19 12h.01
                          M6 12a1 1 0 11-2 0 1 1 0 012 0zm7 0a1 1 0 11-2 0 1 1 0 012 0zm7 0a1 1 0 11-2 0 1 1 0 012 0z"></path>
                </svg>
              </div>

              <ul tabindex="0" class="dropdown-content menu bg-white/80 rounded-box w-25 p-2 shadow-sm text-xs lg:text-sm flex flex-col text-center gap-2">
                <li>
                  <%= link_to edit_post_path(@post), data: { turbo: false } do %>
                    <%= t('helpers.submit.edit') %>
                  <% end %>
                </li>
                <li>
                  <%= link_to post_path(@post), class: "text-error",
                        data: { turbo_method: :delete, turbo_confirm: t('defaults.delete_confirm') } do %>
                    <%= t('helpers.submit.delete') %>
                  <% end %>
                </li>
              </ul>
            </div>
          <% end %>
        </div>
      </div>
    </div>

    <!-- あまピタ度（lg未満で表示） -->
    <div class="lg:hidden flex justify-center w-full py-4">
      <div class="flex flex-col text-center items-start text-sm pb-2 text-neutral">
        <p> あまピタ判定</p>
        <!-- あまピタ度・シェア・いいね -->
        <div class="flex-shrink-0">
          <% rating_images = {
              "lack_of_sweetness" => "smiley-meh.svg",
              "could_be_sweeter" => "smiley-blank.svg",
              "perfect_sweetness" => "smiley-wink.svg",
              "slightly_too_sweet" => "smiley-nervous.svg",
              "too_sweet" => "smiley-x-eyes.svg"
          } %>

          <% bg_colors = {
              "lack_of_sweetness" => "bg-accent",
              "could_be_sweeter" => "bg-accent",
              "perfect_sweetness" => "bg-primary",
              "slightly_too_sweet" => "bg-secondary",
              "too_sweet" => "bg-secondary"
          } %>
          <div class="flex flex-row items-center justify-center gap-2 lg:gap-3 flex-wrap">
            <div class="inline-flex items-center rounded-2xl gap-2 py-2 lg:py-3 px-4 text-neutral text-base <%= bg_colors[@post.sweetness_rating] %>">
              <%= image_tag rating_images[@post.sweetness_rating], class: "h-8 w-8" %>
              <p><%= I18n.t("enums.post.sweetness_rating.#{@post.sweetness_rating}") %></p>
            </div>
            <% if user_signed_in? && current_user.own?(@post) && @post.publish? %>
              <span class="flex flex-col items-center rounded-xl bg-base-200 p-2 sm:p-3">
                <%= link_to "https://twitter.com/intent/tweet?text=#{CGI.escape(@post.x_share_text)}",
                    target: "_blank",
                    rel: "noopener noreferrer" do %>
                  <%= image_tag "x-logo.svg", class: "h-6 w-6" %>
                <% end %>
              </span>
            <% end %>
            <% unless @post.unpublish? || current_user&.own?(@post) %>
              <% if user_signed_in? %>
                <%= render 'posts/like_buttons', { post: @post } %>
              <% else %>
                <label class="cursor-pointer tooltip tooltip-top" 
                      data-tip="<%= t('defaults.require_login') %>">
                  <%= image_tag "heart.svg", class: "h-6 w-6 ml-1" %>
                </label>
              <% end %>
            <% end %>
          </div>
        </div>
      </div>
    </div>
  
    <!-- チャートとレビュー -->
    <div class="flex flex-col lg:flex-row justify-center items-center lg:items-start gap-1 p-3">
      <!-- チャート -->
      <div class="flex justify-center w-full lg:w-3/5 max-w-md">
        <div class="w-full p-1 sm:p-4 border-secondary rounded-3xl bg-white/80 ring-2 ring-stone-200/30">
          <div class="flex justify-center pb-1 text-base">
            甘さ感覚チャート
          </div>
          <div class="mx-auto w-full max-w-md p-2">
            <%= render "shared/chart/sweetness_posts",
                chart_id: "radarChart",
                data: [
                    @post.post_sweetness_score.sweetness_strength,
                    @post.post_sweetness_score.aftertaste_clarity,
                    @post.post_sweetness_score.natural_sweetness,
                    @post.post_sweetness_score.coolness,
                    @post.post_sweetness_score.richness,
                ] %>
          </div>
          <div class="flex justify-end text-xs lg:text-sm pb-2 text-base-200">
            <%= l @post.created_at %>
          </div>
        </div>
      </div>

      <!-- あまピタ度・レビュー・ボタン（lg以上で表示） -->
      <div class="hidden lg:flex flex-col justify-start items-center w-full lg:w-2/5 max-w-md gap-1">
        <div class="flex flex-col text-center items-center text-base py-4 text-neutral">
        <p class="pb-2">あまピタ判定</p>
          <div class="flex-shrink-0">
            <% rating_images = {
                "lack_of_sweetness" => "smiley-meh.svg",
                "could_be_sweeter" => "smiley-blank.svg",
                "perfect_sweetness" => "smiley-wink.svg",
                "slightly_too_sweet" => "smiley-nervous.svg",
                "too_sweet" => "smiley-x-eyes.svg"
            } %>

            <% bg_colors = {
                "lack_of_sweetness" => "bg-accent",
                "could_be_sweeter" => "bg-accent",
                "perfect_sweetness" => "bg-primary",
                "slightly_too_sweet" => "bg-secondary",
                "too_sweet" => "bg-secondary"
            } %>
            <div class="flex flex-row items-center justify-center gap-2 lg:gap-3 flex-wrap">
              <div class="inline-flex items-center rounded-2xl gap-1 py-2 lg:py-3 px-3 text-neutral text-base <%= bg_colors[@post.sweetness_rating] %>">
                <%= image_tag rating_images[@post.sweetness_rating], class: "h-8 w-8" %>
                <p><%= I18n.t("enums.post.sweetness_rating.#{@post.sweetness_rating}") %></p>
              </div>

              <% if user_signed_in? && current_user.own?(@post) && @post.publish? %>
                <span class="flex flex-col items-center rounded-xl bg-base-200 p-2 sm:p-3">
                  <%= link_to "https://twitter.com/intent/tweet?text=#{CGI.escape(@post.x_share_text)}",
                      target: "_blank",
                      rel: "noopener noreferrer" do %>
                    <%= image_tag "x-logo.svg", class: "h-6 w-6" %>
                  <% end %>
                </span>
              <% end %>
            </div>
          </div>
        </div>

        <!-- レビューセクション -->
        <% if @post.review.present? %>
        <div class="px-2 py-4">
          <div class="bg-white/80 py-4 px-1 w-full rounded-4xl flex flex-col items-center relative ring-2 ring-stone-200/30">
            <div class="pb-1 text-base text-neutral">
              レビュー
            </div>
            <div class="flex flex-col justify-center items-center w-full">
              <div class="w-full text-start text-sm p-2">
                <%= @post.review %>
              </div>
            </div>
          </div>
          </div>
        <% end %>

        <!-- 商品詳細ページ -->
        <div class="flex flex-col lg:flex-row justify-center items-center text-center py-7">
          <%= product_detail_link_or_tooltip(@post.product,
              class: "button-primary text-base-100 bg-accent hover-animation") do %>
            みんなのレビューはこちら
          <% end %>
        </div>
      </div>

      <!-- レビューとボタン（lg未満で表示） -->
      <div class="lg:hidden flex flex-col justify-center items-center w-full max-w-md gap-1">
        <!-- レビューセクション -->
        <% if @post.review.present? %>
        <div class="py-4 w-full">
          <div class="bg-white/80 py-4 px-1 w-full ring-2 ring-stone-200/30 rounded-4xl flex flex-col items-center relative">
            <div class="pb-1 text-base text-neutral">
              レビュー
            </div>
            <div class="flex flex-col justify-center items-center w-full">
              <div class="w-full text-start text-sm p-3">
                <%= @post.review %>
              </div>
            </div>
          </div>
        </div>
        <% end %>

        <!-- 商品詳細ページ -->
        <div class="flex flex-col lg:flex-row justify-center items-center text-center pt-4 sm:py-7">
          <%= product_detail_link_or_tooltip(@post.product,
              class: "button-primary text-base-100 bg-accent hover-animation") do %>
            みんなのレビューはこちら
          <% end %>
        </div>
      </div>
    </div>

    <!-- コメント欄 -->
    <div class="w-full max-w-xl mx-auto rounded-4xl px-2 py-6 sm:pb-16">
      <!-- コメントフォーム -->
      <% if user_signed_in? && @post.publish? %>
        <div id="new_comment">
          <%= render "posts/comment_form", post: @post, comment: Comment.new %>
        </div>
      <% end %>
      
      <!-- コメント一覧 -->
      <div id="comments" class="mt-3">
        <%= render @comments %>
      </div>
    </div>
  </div>
</div>