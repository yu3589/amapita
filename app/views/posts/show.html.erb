<% if @show_badge_modal %>
  <%= render "badge_modal", badge_name: @badge_name %>
<% end %>

<div class="lg:p-4 pb-12 sm:pb-4">
  <div class="p-1 w-full max-w-3xl mx-auto bg-base-100 rounded-4xl">
    <h1 class="text-center text-xl lg:text-xl p-2 lg:p-4 border-b border-base-200 w-full">
      <div class="flex items-center justify-center gap-2">
        <% unless @post.publish? %>
          <%= image_tag "lock-key.svg", class: "h-6 w-6 sm:h-7 sm:w-7 mt-1" %>
        <% end %>
        <span><%= t('.title') %></span>
      </div>
    </h1>

    <div class="flex flex-col justify-center items-center sm:flex-row sm:items-start sm:gap-4 relative">
      <div class="flex flex-col items-center gap-4 sm:gap-2 flex-shrink-0">
        <!-- 商品画像 -->
        <figure x-data="{ imageLoaded: false }"
                x-init="imageLoaded = $el.querySelector('img')?.complete || false">
          <div x-cloak x-show="!imageLoaded" class="flex animate-pulse space-x-4">
            <div class="p-4">
              <div class="size-25 sm:size-35 rounded-xl bg-stone-300"></div>
            </div>
          </div>

          <div x-show="imageLoaded" x-transition>
            <div class="p-4">
              <%= @post.decorate.post_image(
                    class: "size-25 sm:size-35",
                    "@load" => "imageLoaded = true",
                    "@error"=> "imageLoaded = true"
                  ) %>
            </div>
          </div>
        </figure>

        <!-- 商品URL -->
        <% if @post.product.product_url.present? %>
          <div class="flex flex-row underline gap-1">
            <%= image_tag "shopping-cart.svg", class: "h-6 w-6" %>
            <%= link_to t('defaults.link.product_url'),
                @post.product.product_url,
                target: "_blank",
                rel: "noopener noreferrer",
                class: "text-sm text-secondary" %>
          </div>
        <% end %>
      </div>

      <div class="flex flex-col justify-start items-center sm:items-start gap-2 text-neutral py-4 md:px-0">
        <div class="flex flex-col gap-1 items-center sm:items-start sm:gap-3 w-full">
          <div class="flex items-center justify-center sm:justify-between w-full gap-2">
            <div class="text-xs sm:text-sm text-base-300 max-w-sm text-center sm:text-left mx-auto sm:mx-0">
              <%= @post.product.manufacturer %>
            </div>
          </div>

          <!-- lg未満：リンク付き -->
          <div class="block lg:hidden text-lg px-1 sm:px-0 max-w-xs text-center sm:text-left mx-auto sm:mx-0 underline decoration-offset-4">
            <%= link_to product_path(@post.product) do %>
              <%= @post.product.name %>
            <% end %>
          </div>

          <!-- lg以上：リンクなし -->
          <div class="hidden lg:block text-lg px-1 sm:px-0 max-w-xs text-center sm:text-left mx-auto sm:mx-0">
            <%= @post.product.name %>
          </div>
        </div>

        <div class="flex flex-col text-base flex-wrap pt-4">
          <%= user_profile_link_or_tooltip(@post.user,
              class: "flex items-center gap-2 md:hover:bg-stone-200/60 md:duration-250 md:rounded-4xl md:px-2 md:w-fit") do %>
            <%= @post.user.decorate.avatar_image(class: "w-10 h-10") %>
            <div class="flex flex-col p-1 gap-2">
              <span class="text-base"><%= @post.user.name %></span>

              <div class="flex flex-row flex-wrap gap-2">
                <span class="flex flex-row gap-1 text-xs rounded-full px-2 py-1 bg-success w-fit">
                  <%= image_tag "badge.svg", class: "h-5 w-5" %>
                  <%= display_post_badge(@post.user) %>
                </span>

                <% if user_signed_in? && @post.user != current_user && sweetness_twin?(@post.user) %>
                  <span class="flex flex-row gap-1 text-xs rounded-full items-center px-2 py-1 bg-info w-fit">
                    <%= image_tag "handshake.svg", class: "h-5 w-5" %>
                    <%= display_sweetness_twin_badge(@post.user) %>
                  </span>
                <% end %>
              </div>
            </div>
          <% end %>

          <!-- 編集・削除＆ブックマーク -->
          <div class="absolute top-2 right-2 sm:right-24 z-10 flex items-center gap-3 sm:gap-4">
            <!-- いいね -->
            <% unless @post.unpublish? || current_user&.own?(@post) %>
              <div class="flex-shrink-0 pb-10">
                <% if user_signed_in? %>
                  <%= render 'posts/like_buttons', { post: @post, button_id: "like-button-#{@post.id}" } %>
                <% else %>
                  <div class="cursor-pointer tooltip tooltip-top z-10" 
                      data-tip="<%= t('defaults.require_login') %>"
                      onclick="location.href='<%= new_user_session_path %>'">
                    <%= image_tag "heart.svg", class: "size-6 ml-1" %>
                  </div>
                <% end %>
              </div>
            <% end %>

            <!-- ブックマーク -->
            <div class="flex-shrink-0 pb-10">
              <% if user_signed_in? %>
                <%= render 'products/bookmark_buttons', { product: @post.product } %>
              <% else %>
                <div class="cursor-pointer tooltip tooltip-top" 
                    data-tip="<%= t('defaults.require_login') %>"
                    onclick="location.href='<%= new_user_session_path %>'">
                  <%= image_tag "bookmark.svg", class: "size-6 ml-1" %>
                </div>
              <% end %>
            </div>

            <!-- 編集・削除 -->
            <% if user_signed_in? && current_user.own?(@post) %>
              <div class="dropdown dropdown-bottom dropdown-end pb-10">
                <div tabindex="0" role="button" class="btn btn-lg btn-square btn-ghost hover:bg-stone-300">
                  <svg xmlns="http://www.w3.org/2000/svg" fill="none"
                      viewBox="0 0 24 24" class="inline-block h-7 w-7 text-base-300 stroke-current">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                          d="M5 12h.01M12 12h.01M19 12h.01
                            M6 12a1 1 0 11-2 0 1 1 0 012 0zm7 0a1 1 0 11-2 0 1 1 0 012 0zm7 0a1 1 0 11-2 0 1 1 0 012 0z"></path>
                  </svg>
                </div>

                <ul tabindex="0" class="dropdown-content menu bg-white rounded-box w-25 p-2 shadow-sm text-xs lg:text-sm flex flex-col text-center gap-2">
                  <li>
                    <%= link_to edit_post_path(@post), data: { turbo: false } do %>
                      <%= t('helpers.submit.edit') %>
                    <% end %>
                  </li>
                  <li>
                    <%= link_to post_path(@post), class: "text-error",
                          data: { turbo_method: :delete, turbo_confirm: t('defaults.delete_confirm') } do %>
                      <%= t('helpers.submit.delete') %>
                    <% end %>
                  </li>
                </ul>
              </div>
            <% end %>
          </div>
        </div>
      </div>
    </div>
  
    <!-- チャートとレビュー -->
    <div class="flex flex-col lg:flex-row justify-center items-center lg:items-start gap-1 px-2">
      <!-- チャート -->
      <div class="flex flex-col justify-center w-full lg:w-3/5 max-w-md pt-2 sm:pt-4 gap-1">
        <!-- lg以下の評価表示 -->
        <div class="lg:hidden flex flex-col text-center items-center text-base text-neutral pb-2">
          <% rating_images = {
              "lack_of_sweetness" => "smiley-meh.svg",
              "could_be_sweeter" => "smiley-blank.svg",
              "perfect_sweetness" => "smiley-wink.svg",
              "slightly_too_sweet" => "smiley-nervous.svg",
              "too_sweet" => "smiley-x-eyes.svg"
          } %>

          <% bg_colors = {
              "lack_of_sweetness" => "bg-accent",
              "could_be_sweeter" => "bg-accent",
              "perfect_sweetness" => "bg-primary",
              "slightly_too_sweet" => "bg-secondary",
              "too_sweet" => "bg-secondary"
          } %>
          <div class="flex flex-row items-center justify-center gap-2 lg:gap-3 flex-wrap">
            <div class="inline-flex items-center rounded-2xl gap-1 py-2 lg:py-3 px-3 text-neutral text-base <%= bg_colors[@post.sweetness_rating] %>">
              <%= image_tag rating_images[@post.sweetness_rating], class: "h-8 w-8" %>
              <p><%= I18n.t("enums.post.sweetness_rating.#{@post.sweetness_rating}") %></p>
            </div>

            <% if user_signed_in? && current_user.own?(@post) && @post.publish? %>
              <%= link_to "https://twitter.com/intent/tweet?text=#{CGI.escape(@post.x_share_text)}",
                    target: "_blank",
                    rel: "noopener noreferrer" do %>
                <span class="flex flex-col items-center rounded-xl bg-base-200 p-2 sm:p-3">
                  <%= image_tag "x-logo.svg", class: "size-6" %>
              </span>
              <% end %>
            <% end %>
          </div>
        </div>

        <div class="w-full p-1 sm:p-4 border-secondary rounded-3xl bg-white/80 ring-2 ring-stone-200/50">
          <div class="flex justify-center pb-2 text-base">
            <%= t('defaults.sweetness_chart') %>
          </div>
          <div class="mx-auto w-full max-w-sm p-0.5">
            <%= render "shared/chart/sweetness_posts",
                chart_id: "radarChart",
                data: [
                    @post.post_sweetness_score.sweetness_strength,
                    @post.post_sweetness_score.aftertaste_clarity,
                    @post.post_sweetness_score.natural_sweetness,
                    @post.post_sweetness_score.coolness,
                    @post.post_sweetness_score.richness,
                ] %>
          </div>
          <div class="flex justify-end text-xs lg:text-sm pb-2 text-base-200">
            <%= l @post.created_at %>
          </div>
        </div>
      </div>

      <!-- 評価部分（lg以上） -->
      <div class="hidden lg:flex flex-col justify-start items-center w-full lg:w-2/5 max-w-md gap-1">
        <div class="flex flex-col text-center items-start text-base py-4 text-neutral">
        <p class="pb-1 pl-2"><%= t('.rating') %></p>
          <div class="flex-shrink-0">
            <% rating_images = {
                "lack_of_sweetness" => "smiley-meh.svg",
                "could_be_sweeter" => "smiley-blank.svg",
                "perfect_sweetness" => "smiley-wink.svg",
                "slightly_too_sweet" => "smiley-nervous.svg",
                "too_sweet" => "smiley-x-eyes.svg"
            } %>

            <% bg_colors = {
                "lack_of_sweetness" => "bg-accent",
                "could_be_sweeter" => "bg-accent",
                "perfect_sweetness" => "bg-primary",
                "slightly_too_sweet" => "bg-secondary",
                "too_sweet" => "bg-secondary"
            } %>
            <div class="flex flex-row items-center justify-center gap-2 lg:gap-3 flex-wrap">
              <div class="inline-flex items-center rounded-2xl gap-1 py-2 lg:py-3 px-3 text-neutral text-base <%= bg_colors[@post.sweetness_rating] %>">
                <%= image_tag rating_images[@post.sweetness_rating], class: "h-8 w-8" %>
                <p><%= I18n.t("enums.post.sweetness_rating.#{@post.sweetness_rating}") %></p>
              </div>

              <% if user_signed_in? && current_user.own?(@post) && @post.publish? %>
                <%= link_to "https://twitter.com/intent/tweet?text=#{CGI.escape(@post.x_share_text)}",
                      target: "_blank",
                      rel: "noopener noreferrer" do %>
                  <span class="flex flex-col items-center rounded-xl bg-base-200 p-2 sm:p-3">
                    <%= image_tag "x-logo.svg", class: "size-6" %>
                </span>
                <% end %>
              <% end %>
            </div>
          </div>
        </div>

        <!-- レビュー -->
        <% if @post.review.present? %>
          <div class="px-2 pt-1 pb-2 w-full">
            <div class="bg-white/80 py-4 px-2 w-full rounded-4xl flex flex-col items-start relative ring-2 ring-stone-200/50">
              <div class="pb-1 text-base text-neutral w-full text-center">
                <%= t('posts.review') %>
              </div>
              <div class="w-full text-sm text-start">
                <%= @post.review %>
              </div>
            </div>
          </div>
        <% end %>
        <!-- 商品詳細ボタン -->
        <div class="flex flex-col lg:flex-row justify-center items-center text-center py-4">
        <%= link_to product_path(@post.product),
            class: "btn text-neutral btn-success flex items-center gap-2" do %>
          <%= image_tag "chat.svg", class: "size-6" %>
          <%= t('.to_product_page') %>
        <% end %>
      </div>
    </div>

    <!-- レビュー -->
    <div class="sm:hidden flex flex-col justify-center items-center w-full max-w-md gap-1">
      <% if @post.review.present? %>
        <div class="px-2 py-4 w-full">
          <div class="bg-white/80 p-2 w-full rounded-4xl flex flex-col items-start relative ring-2 ring-stone-200/50">
            <div class="pb-1 text-base text-neutral w-full text-center">
              <%= t('posts.review') %>
            </div>
            <div class="w-full text-sm text-start p-3">
              <%= @post.review %>
            </div>
          </div>
        </div>
      <% end %>
    </div>
  </div>

  <!-- コメント欄 -->
  <div class="w-full max-w-xl mx-auto rounded-4xl py-5 sm:py-8">
    <% if user_signed_in? && @post.publish? %>
      <div id="new_comment">
        <%= render "posts/comment_form", post: @post, comment: Comment.new %>
      </div>
    <% end %>

    <div id="comments" class="my-4 mx-2">
      <%= render @comments %>
    </div>
  </div>
</div>

<!-- レビュー登録 -->
<div class="floating-new-post-button">
  <%= show_reputation_button(@post, @user_unpublish_post,
      class: "floating_button py-4 px-10 sm:px-7 sm:py-4 2xl:px-10 2xl:py-5 bg-info 2xl:gap-2 hover-animation") do %>
    <%= image_tag "cookie.svg", class: "size-7" %>
    <span class="text-base text-center">
      <%= raw t('defaults.buttons.new_post') %> 
    </span>
  <% end %>
</div>