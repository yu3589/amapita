<% if @show_badge_modal %>
  <%= render "badge_modal", badge_name: @badge_name %>
<% end %>

<div class="p-2 md:p-4">
  <div class="p-2 w-full max-w-3xl mx-auto bg-base-100 rounded-4xl">
    <h1 class="text-center text-xl md:text-2xl p-4 border-b border-base-200 w-full">
      <div class="flex items-center justify-center gap-2">
        <% unless @post.publish? %>
          <%= image_tag "lock-key.svg", class: "h-6 w-6 sm:h-7 sm:w-7 mt-1" %>
        <% end %>
        <span><%= t('.title') %></span>
      </div>
    </h1>

    <div class="flex flex-col justify-center items-center sm:flex-row sm:items-start sm:gap-6">
      <div class="flex flex-col items-center p-4">
        <!-- 商品画像 -->
        <figure x-data="{ imageLoaded: false }"
                x-init="imageLoaded = $el.querySelector('img')?.complete || false">
          <div x-cloak x-show="!imageLoaded" class="flex animate-pulse space-x-4">
          <div class="p-4">
            <div class="size-22 sm:size-35 rounded-xl bg-base-200"></div>
          </div>
          </div>

          <div x-show="imageLoaded" x-transition>
          <div class="p-4">
              <%= @post.decorate.post_image(
                    class: "size-22 sm:size-35",
                          "@load" => "imageLoaded = true",
                          "@error"=> "imageLoaded = true"
                  ) %>
            </div>
          </div>
        </figure>

        <!-- 商品URL -->
        <% if @post.product.product_url.present? %>
          <div class="flex flex-row underline gap-1">
            <%= image_tag "shopping-cart.svg", class: "h-6 w-6" %>
              <%= link_to t('defaults.link.product_url'),
                  @post.product.product_url,
                  target: "_blank",
                  rel: "noopener noreferrer",
                  class: "text-sm text-secondary" %>
          </div>
        <% end %>
      </div>

      <div class="flex flex-col justify-start items-start gap-2 md:gap-4 text-neutral px-10 md:px-0 md:pt-6">
        <div class="text-xl">
          <%= @post.product.name %>
        </div>
        
        <div class="flex flex-col text-base">
          <%= user_profile_link_or_tooltip(@post.user,
              class: "flex items-center md:gap-2 hover:opacity-70") do %>
            <%= @post.user.decorate.avatar_image(class: "w-10 h-10") %>
            <div class="flex flex-col p-2 md:p-1 gap-2">
              <span class="font-medium"><%= @post.user.name %></span>
              <span class ="flex flex-row gap-1 text-xs rounded-full px-2 py-1 bg-success">
                <%= image_tag "badge.svg", class: "h-5 w-5" %>
                  <%= display_post_badge(@post.user) %>
              </span>
              <% if user_signed_in? && @post.user != current_user && sweetness_twin?(@post.user) %>
                <span class="flex flex-row gap-1 text-xs rounded-full items-center px-2 py-1 bg-info w-fit">
                  <%= image_tag "handshake.svg", class: "h-5 w-5" %>
                  <%= display_sweetness_twin_badge(@post.user) %>
                </span>
              <% end %>
            </div>
          <% end %>
        </div>

        <!-- 評価部分 -->
        <div class="flex-shrink-0">
          <% rating_images = {
              "lack_of_sweetness" => "smiley-meh.svg",
              "could_be_sweeter" => "smiley-blank.svg",
              "perfect_sweetness" => "smiley-wink.svg",
              "slightly_too_sweet" => "smiley-nervous.svg",
              "too_sweet" => "smiley-x-eyes.svg"
          } %>

          <% bg_colors = {
              "lack_of_sweetness" => "bg-accent",
              "could_be_sweeter" => "bg-accent",
              "perfect_sweetness" => "bg-primary",
              "slightly_too_sweet" => "bg-secondary",
              "too_sweet" => "bg-secondary"
          } %>

          <div class="inline-flex items-center rounded-2xl gap-2 py-2 md:py-3 px-4 text-neutral text-base <%= bg_colors[@post.sweetness_rating] %>">
            <%= image_tag rating_images[@post.sweetness_rating], class: "h-8 w-8" %>
            <p><%= I18n.t("enums.post.sweetness_rating.#{@post.sweetness_rating}") %></p>
          </div>

          <!-- 編集・削除ボタン -->
          <% if user_signed_in? && current_user.own?(@post) %>
            <div class="flex gap-4 pt-4 justify-end">
              <%= link_to edit_post_path(@post), class: "text-sm ring-accent px-4 py-2 text-neutral ring-4 rounded-full transition duration-200 bg-base-100 hover:brightness-96", data: { turbo: false } do %>
                編集
              <% end %>
              <%= link_to post_path(@post), class: "text-sm ring-secondary px-4 py-2 text-neutral ring-4 rounded-full transition duration-200 bg-base-100 hover:brightness-96", data: { turbo_method: :delete, turbo_confirm: t('defaults.delete_confirm') } do %>
                削除
              <% end %>
            </div>
          <% end %>
        </div>
      </div>
    </div>
  
    <!-- チャート -->
    <div class="flex justify-center p-2">
      <div class="w-full max-w-lg sm:max-w-xl lg:max-w-xl p-2 border-secondary rounded-3xl bg-white">
        <div class="mx-auto w-full max-w-md">
          <%= render "shared/chart/sweetness_posts",
              chart_id: "radarChart",
              data: [
                  @post.post_sweetness_score.sweetness_strength,
                  @post.post_sweetness_score.aftertaste_clarity,
                  @post.post_sweetness_score.natural_sweetness,
                  @post.post_sweetness_score.coolness,
                  @post.post_sweetness_score.richness,
              ] %>
        </div>
      </div>
    </div>

    <!-- レビューセクション -->
    <div class="p-2 md:p-4">
      <div class="p-2 w-full max-w-xl mx-auto bg-white rounded-4xl mb-6">
        <div class="text-center text-xl p-2 text-neutral">
          レビュー
        </div>
        <div class="flex flex-col justify-center items-center">
          <% if @post.review.present? %>
            <div class="w-full text-start p-3">
              <%= @post.review %>
            </div>
              <div class="w-full px-3 py-1 text-sm text-base-200 text-right">
                <%= l @post.created_at %>
              </div>
          <% else %>
            <div class="w-full p-3 text-base-200">レビューがありません</div>
          <% end %>
            <% if @post.publish? %>
            <div class="w-full p-2 border-b border-base-200 text-neutral">
            </div>
          <% end %>
          <!-- いいね -->
          <% if @post.publish? %>
            <div class="flex flex-row pt-2 text-sm gap-6 md:gap-30 text-base-200">
              <span class="flex items-center gap-1">
              <% if user_signed_in? %>
                <%= render 'like_buttons', { post: @post } %>
              <% else %>
                <label class="cursor-pointer tooltip tooltip-top" 
                      data-tip="<%= t('defaults.require_login') %>">
                  <%= image_tag "heart.svg", class: "h-6 w-6 ml-1" %>
                </label>
              <% end %>
              </span>
            </div>
          <% end %>
        </div>
      </div>
    </div>

    <div class="w-full max-w-xl mx-auto rounded-4xl px-2">
      <!-- コメントフォーム -->
      <% if user_signed_in? && @post.publish? %>
        <div id="new_comment">
          <%= render "posts/comment_form", post: @post, comment: Comment.new %>
        </div>
      <% end %>
      
      <!-- コメント一覧 -->
      <div id="comments" class="mt-3">
        <%= render @comments %>
      </div>
    </div>

      <div class="pt-6 pb-10 sm:p-5 flex flex-col md:flex-row justify-center items-center text-center">
        <%= product_detail_link_or_tooltip(@post.product,
            class: "button-primary text-base-100 bg-primary") do %>
            みんなのあまピタ判定はこちら
        <% end %>
      </div>
    </div>
  </div>
</div>
