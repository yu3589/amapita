<div tabindex="0" class="collapse collapse-arrow bg-base-100 border-base-100 border
            p-0.5 rounded-4xl text-sm text-stone-400 w-fit ring-stone-300 ring-2">
  <div class="collapse-title relative flex items-center justify-center gap-2 sm:gap-1">
    <%= image_tag "warning.svg", class: "size-5" %>
    <span class="text-error"><%= t('defaults.notice.about') %></span>
  </div>
  <div class="collapse-content text-sm text-left space-y-0.5">
    <p><%= t('defaults.notice.usage_guideline') %></p>
    <p><%= t('defaults.notice.side_effects') %></p>
    <p>・全く異なる商品を登録する場合は、<span class="md:hidden"><br></span>
      <%= link_to "新規商品登録", categories_path,
          class: "text-secondary hover:text-secondary underline" %>からお願いいたします。</p>
  </div>
</div>

<!-- 既存の商品情報 -->
<div class="flex flex-col justify-center items-center py-3 px-1 sm:p-4 space-y-2 rounded-4xl bg-white/80 max-w-md mx-auto ring-stone-100 ring-2">
  <p class="text-text-neutral text-sm py-1">
    <%= t('posts.edit.current_product_information') %>
  </p>

  <div class="flex flex-col sm:flex-row items-center sm:items-start justify-center w-full gap-4">
    <!-- 画像 -->
    <figure x-data="{ imageLoaded: false }"
            x-init="imageLoaded = $el.querySelector('img')?.complete || false">
      <div x-cloak x-show="!imageLoaded" class="flex animate-pulse space-x-4">
        <div class="flex flex-col items-center">
          <div class="size-22 sm:size-30 rounded-xl bg-stone-300"></div>
        </div>
      </div>

      <div x-show="imageLoaded" x-transition>
        <div class="flex flex-col items-center">
          <%= @post.product.decorate.product_image(
                class: "size-22 sm:size-30",
                "@load" => "imageLoaded = true",
                "@error"=> "imageLoaded = true"
              ) %>
        </div>
      </div>
    </figure>

    <!-- 商品情報 -->
    <div class="flex flex-col justify-center text-sm text-neutral text-start gap-4 pt-3">
      <%= f.hidden_field :product_id, value: @post.product.id %>
      <p><%= t('activerecord.attributes.product.name') %>：<%= @post.product.name %></p>
      <p><%= t('activerecord.attributes.product.manufacturer') %>：<%= @post.product.manufacturer %></p>
      <p><%= t('activerecord.attributes.product.category_id') %>：<%= @post.product.category.name %></p>
    </div>
  </div>
</div>

<div data-controller="rakuten-search">
  <%= f.fields_for :product do |p| %>

    <!-- 商品名 -->
    <div class="space-y-2 flex flex-col items-center">
      <div class="form-control items-center w-full max-w-sm mx-auto">
        <div class="flex flex-row justify-center items-center gap-1">
            <%= p.label :name, class: "label p-2 text-neutral" %>
            <span class="text-error">*</span>
            <div class="dropdown dropdown-top dropdown-hover pl-1">
            <div tabindex="0" role="button" class="btn btn-xs btn-white/80 btn-circle">?</div>
            <ul tabindex="0" class="dropdown-content menu bg-base-100 text-base-300 rounded-box z-10 w-35 p-1 shadow-sm text-xs">
                <li><a><%= t('defaults.dropdown.post_search_description') %></a></li>
            </ul>
            </div>
        </div>

        <div class="flex justify-center gap-1 w-full items-center">
          <%= p.search_field :name,
              class: "input input-bordered flex-1 bg-white/80",
              placeholder: t("defaults.placeholders.require_word"),
              data: { rakuten_search_target: "keyword" } %>
          <button type="button" 
                  class="btn btn-secondary text-xs"
                  data-action="click->rakuten-search#search">
            <%= raw t("defaults.buttons.search_rakuten") %> 
          </button>
        </div>
      </div>

      <div class="form-control hidden" data-rakuten-search-target="loading">
        <div class="flex justify-center items-center gap-2 pt-4 text-secondary">
          <span class="loading loading-spinner loading-md"></span>
        </div>
      </div>

      <div class="form-control hidden pt-2 " data-rakuten-search-target="error">
        <div class="text-sm text-error">
          <span data-rakuten-search-target="errorMessage"></span>
        </div>
      </div>

      <div data-rakuten-search-target="results"
           class="hidden mt-4"
           data-store-icon-path="<%= asset_path('store.svg') %>">
      </div>

      <%= p.hidden_field :product_url, data: { rakuten_search_target: "url" } %>
      <%= p.hidden_field :product_image_url, data: { rakuten_search_target: "imageUrl" } %>
    </div>

    <!-- メーカー・カテゴリ -->
    <div class="sm:flex sm:flex-row sm:justify-center sm:items-center sm:gap-3 mt-4">
      <div class="form-control">
        <div class="label p-2 text-neutral flex justify-center items-center space-x-1">
          <%= p.label :manufacturer %>
          <span class="text-error">*</span>
        </div>

        <%= p.text_field :manufacturer, 
                list: "manufacturer_list",
                placeholder: t("defaults.placeholders.manufacturer"),
                data: { rakuten_search_target: "manufacturer" },
                class: "input input-bordered bg-white/80" %>
        <%= tag.div id: "manufacturer-mapping", 
                data: { mapping: I18n.t("products.manufacturers.mapping").to_json }, 
                style: "display:none;" %>
        </div>

        <!-- カテゴリ -->
        <div class="form-control">
        <div class="label p-2 text-neutral flex justify-center items-center space-x-1">
            <%= p.label :category_id %>
            <span class="text-error">*</span>
        </div>
        <%= p.select :category_id,
                options_from_collection_for_select(Category.all, :id, :name, @post.product.category_id),
                { prompt: t("defaults.select.category") },
                class: "select select-bordered bg-white/80",
                data: { rakuten_search_target: "categorySelect" } %>
      </div>
    </div>

    <!-- 画像選択 -->
    <div class="form-control" data-controller="image-source-selector">
      <div class="flex flex-row justify-center items-center gap-1 sm:pt-4 pb-1">
        <%= p.label :image, t('posts.edit.product_image_source'), class: "label py-4 text-neutral" %>
      </div>

      <%= p.hidden_field :remove_image, 
          value: @post.product.image.attached? ? "false" : "true",
          data: { image_source_selector_target: "removeImageFlag" } %>

      <!-- ラジオボタン -->
      <div class="flex flex-col items-center sm:flex-row sm:items-start justify-center gap-4 mb-4">
        <div class="flex flex-col items-start sm:flex-row sm:items-start gap-5 sm:gap-6">
          <label class="flex items-start cursor-pointer gap-2">
            <%= radio_button_tag 'image_source', 'uploaded',
                @post.product.image.attached?,
                class: "radio radio-sm radio-secondary",
                data: { 
                  action: "change->image-source-selector#toggle",
                  image_source_selector_target: "uploadedRadio"
                } %>
            <span class="label-text text-sm"><%= t('posts.edit.use_uploaded_image') %></span>
          </label>

          <label class="flex items-start cursor-pointer gap-2">
            <%= radio_button_tag 'image_source', 'url',
                !@post.product.image.attached? && @post.product.product_image_url.present?,
                class: "radio radio-sm radio-secondary",
                data: { 
                  action: "change->image-source-selector#toggle",
                  image_source_selector_target: "urlRadio"
                } %>
            <span class="label-text text-sm"><%= t('posts.edit.use_rakuten_image') %></span>
          </label>
        </div>
      </div>

      <!-- アップロード画像 -->
      <div data-image-source-selector-target="fileSection" class="<%= 'hidden' unless @post.product.image.attached? %>">
        <div class="flex flex-col items-center gap-2 py-1">
          <%= p.file_field :image,
              class: "file-input file-input-secondary text-base-300" %>
          <div class="flex items-center justify-center flex-col text-xs text-stone-400 pb-4">
            <%= t('defaults.image_upload_limit') %>
          </div>
      </div>

      <!-- 楽天画像 -->
      <div data-image-source-selector-target="urlSection" class="<%= 'hidden' if @post.product.image.attached? %>">
        <div class="flex items-center justify-center flex-col text-sm text-stone-400 gap-1 pl-5">
          <div class="text-left leading-relaxed">
            <p><%= t('posts.edit.search_rakuten_for_image') %></p>
            <p><%= t('posts.edit.rakuten_search_hint') %></p>
          </div>
        </div>
      </div>
    </div>
  </div>
<% end %>

<div class="flex justify-center w-full">
  <div class="py-2 px-4 rounded-4xl text-sm text-stone-400 w-fit ring-base-200 ring-2">
    <div class="text-left">
      <div class="flex items-center gap-2">
        <%= image_tag "warning-circle.svg", class: "h-5 w-5 flex-shrink-0" %>
        <span><%= raw t('defaults.notice.product_image') %></span>
      </div>
    </div>
  </div>
</div>

<%= render "section_divider" %>
