<%= search_form_for q_new, as: :q_new, url: posts_path, method: :get,
    class: 'p-1 md:p-4 flex justify-center',
    data: { search_clear_target: "form" } do |f| %>

  <div class="flex flex-col items-center text-sm sm:text-base bg-base-100 ring-stone-200/50 ring-1 rounded-4xl py-3 px-2 md:p-4 max-w-md md:max-w-4xl mx-auto gap-2">
    <div class="py-1">
      <%= t('posts.index.search_title.new_posts') %>
    </div>
    <!-- キーワード検索 -->
    <div class="flex flex-row items-stretch md:items-center gap-1 md:gap-2 w-full">
      <%= f.search_field :review_or_product_name_or_user_name_or_category_name_or_product_manufacturer_cont, 
        class: "flex-1 bg-white/80 p-2 rounded-4xl ring-3 w-full md:w-100 ring-stone-200 text-base px-4",
        placeholder: t('defaults.placeholders.search_word'),
        data: { search_clear_target: "input" } %>

      <%= button_tag type: "submit", class: "btn btn-secondary flex items-center justify-center" do %>
        <%= image_tag "magnifying-glass.svg", alt: t('helpers.submit.search'), class: "size-5" %>
      <% end %>

        <button type="button" onclick="location.href='<%= url_for(only_path: true) %>'"class="btn">
          <%= image_tag "eraser.svg", alt: t('helpers.submit.clear'), class: "size-5" %>
        </button>
    </div>

    <!-- 詳細検索 -->
    <div class="w-full text-sm">
      <div class="grid grid-cols-2 gap-2 md:gap-4 px-1 md:px-6">
        <!-- カテゴリ -->
        <div class="col-span-1">
          <%= f.label :category_id, t('activerecord.models.category') %>
          <%= f.select :category_name_eq,
                I18n.t('categories.list'),
                { include_blank: t('defaults.pull_down') },
                  class: "select w-full text-xs sm:text-sm bg-white/70",
                  data: { search_clear_target: "select" } %>
        </div>

        <!-- メーカー -->
        <div class="col-span-1">
          <%= f.label :manufacturer, t('activerecord.attributes.product.manufacturer') %>
          <%= f.select :product_manufacturer_eq,
                I18n.t('products.manufacturers.list'),
                { include_blank: t('defaults.pull_down') },
                class: "select w-full text-xs sm:text-sm bg-white/70",
                data: { search_clear_target: "select" } %>
          </div>
        </div>

        <!-- あまピタ度 -->
        <div class="mt-3">
          <div class="form-control">
            <div class="bg-white/70 p-1 px-2 rounded-3xl ring-stone-200 ring-3 mx-auto w-fit relative">
              <div class="relative flex justify-center items-center md:mb-2">
                <%= f.label :sweetness_rating_eq, 
                      t('activerecord.attributes.post.sweetness_rating'),
                      class: "text-neutral text-sm text-center w-full" %>

                <!-- クリアボタン -->
                <button type="button" 
                        class="btn btn-xs btn-white absolute right-0 flex items-center gap-1"
                        onclick="clearSweetnessRating(event)">
                  <%= image_tag "eraser.svg", alt: t('helpers.submit.clear'), class: "size-5" %>
                  <span><%= t('helpers.submit.clear') %></span>
                </button>
              </div>

              <div class="flex flex-wrap justify-center gap-3 md:gap-6 pt-1 rounded-4xl text-sm">
                <% 
                  rating_images = {
                    "lack_of_sweetness" => "smiley-meh.svg",
                    "could_be_sweeter" => "smiley-blank.svg",
                    "perfect_sweetness" => "smiley-wink.svg",
                    "slightly_too_sweet" => "smiley-nervous.svg",
                    "too_sweet" => "smiley-x-eyes.svg"
                  }

                  hover_colors = {
                    "lack_of_sweetness" => "hover:bg-accent",
                    "could_be_sweeter" => "hover:bg-accent", 
                    "perfect_sweetness" => "hover:bg-primary",
                    "slightly_too_sweet" => "hover:bg-secondary",
                    "too_sweet" => "hover:bg-secondary"
                  }

                  selected_colors = {
                    "lack_of_sweetness" => "peer-checked:bg-accent",
                    "could_be_sweeter" => "peer-checked:bg-accent",
                    "perfect_sweetness" => "peer-checked:bg-primary", 
                    "slightly_too_sweet" => "peer-checked:bg-secondary",
                    "too_sweet" => "peer-checked:bg-secondary"
                  }

                  tooltips = {
                    "lack_of_sweetness" => "あまさが足りない",
                    "could_be_sweeter" => "もう少し甘さがほしい",
                    "perfect_sweetness" => "あまピタッ！",
                    "slightly_too_sweet" => "少しあますぎ",
                    "too_sweet" => "あますぎ"
                  }
                %>

                <% Post.sweetness_ratings.keys.each do |rating_key| %>
                  <% checked = params.dig(:q_new, :sweetness_rating_eq).to_s == Post.sweetness_ratings[rating_key].to_s %>
                  <label class="flex flex-col items-center cursor-pointer tooltip tooltip-bottom sweetness-label" 
                        data-tip="<%= tooltips[rating_key] %>">
                    <%= f.radio_button :sweetness_rating_eq, Post.sweetness_ratings[rating_key],
                        class: "hidden peer sweetness-radio",
                        checked: checked %>

                    <span class="rating-indicator p-2 rounded-4xl transition-all duration-300
                                <%= hover_colors[rating_key] %>
                                peer-checked:bg-<%= selected_colors[rating_key].split('-').last %> 
                                <%= 'bg-' + selected_colors[rating_key].split('-').last if checked %>">
                      <%= image_tag rating_images[rating_key], class: "w-8 h-8 pointer-events-none" %>
                    </span>
                  </label>
                <% end %>

              </div>
            </div>
          </div>
        </div>

        <script>
          function clearSweetnessRating(event) {
            event.preventDefault();
            // すべてのラジオボタンの選択を解除
            document.querySelectorAll('.sweetness-radio').forEach(radio => {
              radio.checked = false;
            });
          }
        </script>

      </div>
  </div>
<% end %>
